# Run pre-compiled Unison demo application
# Requires: make compile (generates compiled/main.uc locally)
# UCM version MUST match the version used to compile locally

FROM debian:bookworm-slim

ARG TARGETARCH
ARG UCM_VERSION=1.0.0

USER root
WORKDIR /app

# Install dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user
RUN useradd --system --create-home --home-dir /home/nonroot nonroot

# Download and install UCM (same version as local compile)
RUN if [ "$TARGETARCH" = "arm64" ]; then \
        UCM_ARCH="arm64"; \
    else \
        UCM_ARCH="x64"; \
    fi && \
    echo "Downloading UCM ${UCM_VERSION} for ${UCM_ARCH}..." && \
    curl -fsSL "https://github.com/unisonweb/unison/releases/download/release/${UCM_VERSION}/ucm-linux-${UCM_ARCH}.tar.gz" \
        -o /tmp/ucm.tar.gz && \
    mkdir -p /opt/unison && \
    tar -xzf /tmp/ucm.tar.gz -C /opt/unison && \
    rm /tmp/ucm.tar.gz && \
    chmod +x /opt/unison/ucm

ENV PATH="/opt/unison:${PATH}"

RUN ucm version || echo "UCM installed"

# Copy pre-compiled bytecode (generated by make compile)
COPY compiled/main.uc ./compiled/

# Copy entrypoint
COPY entrypoint.sh ./
RUN chmod +x entrypoint.sh

RUN chown -R nonroot:nonroot /app

USER nonroot
WORKDIR /app
ENV HOME=/app

CMD ["./entrypoint.sh"]
